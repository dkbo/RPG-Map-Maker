"use strict";var init={},image=new Image;init.wheelSpeed=4,init.moveSpeed=1,init.mapSetinterval=1e3/60,init.map={left:!1,up:!1,right:!1,down:!1},init.alt=!1,init.drawIsMove=!1,init.mouseDownX=0,init.mouseDownY=0,init.mouseMoveX=0,init.mouseMoveY=0,init.mouseMoveW=0,init.mouseMoveH=0,init.isMoveArr=[],init.arr=[],init.img=["http://dkbo.github.io/images/rpg_maker_xp.png"],init.pre=[];var Sprites=React.createClass({displayName:"Sprites",render:function(){return React.createElement("div",{style:this.props.style,id:"sprites",onWheel:this.props.onWheel,onMouseDown:this.props.onMouseDown,onContextMenu:this.props.onContextMenu},this.props.children)}}),Top=React.createClass({displayName:"Top",render:function(){return React.createElement("div",{id:"top"},this.props.children)}}),Root=React.createClass({displayName:"Root",getDefaultProps:function(){return{left:-init.moveSpeed,right:init.moveSpeed,up:-init.moveSpeed,down:init.moveSpeed,map:{width:1920,height:1080,sX:32,sY:32}}},getInitialState:function(){return{sprite:{top:0},objectNum:0,mapObjects:null,mapTop:0,mapLeft:0,width:this.props.map.width,height:this.props.map.height,sourceX:!1,sourceY:!1,sourceW:this.props.map.sX,sourceH:this.props.map.sY,gridX:!1,gridY:!1,opacityF:1,opacityB:1,opacityM:1,json:null,jsonParse:{styles:[],isMove:[]},spritesSrc:"http://dkbo.github.io/images/rpg_maker_xp.png"}},handleMouseDown:function(t){if(init.scontext.clearRect(0,0,256,12e3),0==t.button){var e=(window.innerHeight,this.props.map.sX*Math.floor(t.clientX/this.props.map.sX)),i=this.props.map.sY*Math.floor((t.clientY-100+this.props.map.sY*-this.state.sprite.top)/this.props.map.sY),a=this.state.sourceW,s=this.state.sourceH;this.state.sourceX===!1?this.setState({sourceX:e,sourceY:i}):(e>this.state.sourceX?(a=e-this.state.sourceX+this.props.map.sX,e=this.state.sourceX):a=this.state.sourceX-e+this.props.map.sX,i>this.state.sourceX?(s=i-this.state.sourceY+this.props.map.sY,i=this.state.sourceY):s=this.state.sourceY-i+32,this.setState({sourceX:e,sourceY:i,sourceW:a,sourceH:s})),init.scontext.beginPath(),init.scontext.rect(e,i,a,s),init.scontext.fillStyle="rgba(27, 136, 224, 0.53)",init.scontext.fill(),init.scontext.lineWidth=2,init.scontext.strokeStyle="black",init.scontext.stroke()}else this.setState({sourceX:!1,sourceY:!1,sourceW:this.props.map.sX,sourceH:this.props.map.sY})},handleWheel:function(t){var e=t.deltaY/100*init.wheelSpeed,i=this.state.sprite;i.top+-e<=0&&(i.top+=-e,this.setState({sprite:i}))},handleChange:function(t){var e=JSON.parse(t.target.value);"object"==typeof e&&(t.target.value=null,this.drawJson(e))},handleObjectName:function(t){init.objectName=t.target.value},handleSprite:function(t){var e;if(this.isReaptImg(t.target.value)){{init.pre.length}e=new Image,e.src=t.target.value,init.img.push(e.src)}this.setState({spritesSrc:t.target.value})},isReaptImg:function(t){for(var e=0;e<init.img.length;e++)if(init.img[e]===t)return!1;return!0},mapWidth:function(t){this.setState({width:t.target.value})},mapHeight:function(t){this.setState({height:t.target.value})},contextMenu:function(t){t.preventDefault()},drawJson:function(t){var e=t.styles,i=this.state;init.fcontext.clearRect(0,0,i.width,i.height),init.bcontext.clearRect(0,0,i.width,i.height),init.mcontext.clearRect(0,0,i.width,i.height);for(var a=0;a<e.length;a++)this.drawJsonPreImg(e[a].b)&&(image.src=e[a].b,2==e[a].z?init.fcontext.drawImage(image,e[a].x,e[a].y,e[a].w,e[a].h,e[a].l,e[a].t,e[a].w,e[a].h):init.bcontext.drawImage(image,e[a].x,e[a].y,e[a].w,e[a].h,e[a].l,e[a].t,e[a].w,e[a].h));for(var a=0;a<t.isMove.length;a++)init.mcontext.beginPath(),init.mcontext.rect(t.isMove[a].x,t.isMove[a].y,t.isMove[a].w,t.isMove[a].h),init.mcontext.fillStyle="rgba(27, 136, 224, 0.83)",init.mcontext.fill();init.arr=e,init.isMoveArr=t.isMove,this.setState({json:JSON.stringify(t,null,"	")})},drawJsonPreImg:function(t){for(var e=!1,i=0;i<init.img.length;i++)if(t===init.img[i]){e=!0;break}return e||(img=new Image,img.onload=function(){return e}.bind(this),img.src=t,init.img.push(t)),e},drawDown:function(t){var e=Math.floor((t.clientX-256-this.state.mapLeft*this.props.map.sX)/this.props.map.sX)*this.props.map.sX,i=Math.floor((t.clientY-100-this.state.mapTop*this.props.map.sY)/this.props.map.sY)*this.props.map.sY;if(this.state.sourceX!==!1)switch(t.button){case 0:this.draw(e,i,0);break;case 2:this.draw(e,i,2)}else if(init.alt)switch(t.button){case 0:init.drawIsMove=!0,init.mouseDownX=t.clientX,init.mouseDownY=t.clientY}},drawMove:function(t){init.drawIsMove&&(init.mcontext.clearRect(init.mouseMoveX,init.mouseMoveY,init.mouseMoveW,init.mouseMoveH),init.mouseMoveX=t.clientX>init.mouseDownX?init.mouseDownX-255-this.state.mapLeft*this.props.map.sX:t.clientX-255-this.state.mapLeft*this.props.map.sX,init.mouseMoveY=t.clientY>init.mouseDownY?init.mouseDownY-100-this.state.mapTop*this.props.map.sY:t.clientY-100-this.state.mapTop*this.props.map.sY,init.mouseMoveW=t.clientX-init.mouseDownX>0?t.clientX-init.mouseDownX:init.mouseDownX-t.clientX,init.mouseMoveH=t.clientY-init.mouseDownY>0?t.clientY-init.mouseDownY:init.mouseDownY-t.clientY,init.mcontext.beginPath(),init.mcontext.rect(init.mouseMoveX,init.mouseMoveY,init.mouseMoveW,init.mouseMoveH),init.mcontext.fillStyle="rgba(27, 136, 224, 0.83)",init.mcontext.fill())},drawUp:function(t){!this.state.sourceX&&init.alt&&(init.drawIsMove=!1,this.pushIsMove())},pushIsMove:function(){var t={};t.n=init.objectName,t.x=init.mouseMoveX,t.y=init.mouseMoveY,t.w=init.mouseMoveW,t.h=init.mouseMoveH,init.mouseMoveX=0,init.mouseMoveY=0,init.mouseMoveW=0,init.mouseMoveH=0,init.isMoveArr.push(t);var e={styles:init.arr,isMove:init.isMoveArr};this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e,objectNum:init.isMoveArr.length-1,mapObjects:3})},mapKeyDown:function(t){switch(t.keyCode){case 71:this.drawGridX(),this.drawGridY();break;case 70:this.opacityF();break;case 66:this.opacityB();break;case 77:this.opacityM();break;case 37:init.map.left=!0;break;case 65:init.map.left=!0;break;case 39:init.map.right=!0;break;case 68:init.map.right=!0;break;case 38:init.map.up=!0;break;case 87:init.map.up=!0;break;case 40:init.map.down=!0;break;case 83:init.map.down=!0,this.save();break;case 76:this.load();break;case 67:this.clear();break;case 18:init.alt=!0}},mapKeyUp:function(t){switch(t.keyCode){case 37:init.map.left=!1;break;case 65:init.map.left=!1;break;case 39:init.map.right=!1;break;case 68:init.map.right=!1;break;case 38:init.map.up=!1;break;case 87:init.map.up=!1;break;case 40:init.map.down=!1;break;case 83:init.map.down=!1;break;case 18:init.alt=!1}},opacityF:function(){this.setState({opacityF:this.state.opacityF?0:1})},opacityB:function(){this.setState({opacityB:this.state.opacityB?0:1})},opacityM:function(){this.setState({opacityM:this.state.opacityM?0:1})},drawGridX:function(){if(this.state.gridX)init.gcontext.clearRect(0,0,this.state.width,this.state.height);else{init.gcontext.beginPath();for(var t=1;t<this.state.width/this.props.map.sX;t++)init.gcontext.moveTo(t*this.props.map.sX,this.props.map.sY),init.gcontext.lineTo(t*this.props.map.sX,this.state.height),init.gcontext.font="italic .5em Calibri",init.gcontext.textAlign="center",init.gcontext.fillText(t*this.props.map.sX,t*this.props.map.sX,20);init.gcontext.stroke()}this.setState({gridX:!this.state.gridX})},drawGridY:function(){if(this.state.gridY)init.gcontext.clearRect(0,0,this.state.width,this.state.height);else{init.gcontext.beginPath();for(var t=1;t<this.state.height/this.props.map.sY;t++)init.gcontext.moveTo(this.props.map.sX,t*this.props.map.sY),init.gcontext.lineTo(this.state.width,t*this.props.map.sY),init.gcontext.font="italic .5em Calibri",init.gcontext.textAlign="center",init.gcontext.fillText(t*this.props.map.sY,20,t*this.props.map.sY+4);init.gcontext.stroke()}this.setState({gridY:!this.state.gridY})},save:function(){if(init.alt){var t={width:this.state.width,height:this.state.height},e={styles:init.arr,isMove:init.isMoveArr};localStorage.dkbo=JSON.stringify(e),localStorage.dkbomap=JSON.stringify(t)}},load:function(){if(init.alt){var t=JSON.parse(localStorage.dkbomap);this.setState({width:t.width,height:t.height}),this.drawJson(JSON.parse(localStorage.dkbo))}},clear:function(){if(init.alt){this.state.opacityF&&this.state.opacityB&&(init.fcontext.clearRect(0,0,this.state.width,this.state.height),init.bcontext.clearRect(0,0,this.state.width,this.state.height),init.arr=[]),this.state.opacityM&&(init.mcontext.clearRect(0,0,this.state.width,this.state.height),init.isMoveArr=[]);var t={styles:init.arr,isMove:init.isMoveArr};this.setState({json:JSON.stringify(t,null,"	"),jsonParse:t,mapObjects:null})}},draw:function(t,e,i){var a=this.state,s=2;image.src=this.state.spritesSrc;var n={n:init.objectName,l:t,t:e,w:a.sourceW,h:a.sourceH,b:image.src,x:a.sourceX,y:a.sourceY};2==i?(n.z=2,s=1,init.fcontext.drawImage(image,a.sourceX,a.sourceY,a.sourceW,a.sourceH,t,e,a.sourceW,a.sourceH)):init.bcontext.drawImage(image,a.sourceX,a.sourceY,a.sourceW,a.sourceH,t,e,a.sourceW,a.sourceH),init.arr.push(n),n={styles:init.arr,isMove:init.isMoveArr},this.setState({json:JSON.stringify(n,null,"	"),jsonParse:n,objectNum:init.arr.length-1,mapObjects:s})},drawIsMove:function(t,e){},mapMove:function(){init.alt||(init.map.left&&this.state.mapLeft-this.props.left<=0&&this.setState({mapLeft:this.state.mapLeft-this.props.left}),init.map.right&&this.setState({mapLeft:this.state.mapLeft-this.props.right}),init.map.up&&this.state.mapTop-this.props.up<=0&&this.setState({mapTop:this.state.mapTop-this.props.up}),init.map.down&&this.setState({mapTop:this.state.mapTop-this.props.down}))},componentDidMount:function(){var t=document.getElementById("objectFront"),e=document.getElementById("objectBack"),i=document.getElementById("objectIsMove"),a=document.getElementById("spriteCanvas"),s=document.getElementById("grid");init.fcontext=t.getContext("2d"),init.bcontext=e.getContext("2d"),init.mcontext=i.getContext("2d"),init.scontext=a.getContext("2d"),init.gcontext=s.getContext("2d"),$(window).on("keydown",this.mapKeyDown),$(window).on("keyup",this.mapKeyUp),this.timer=setInterval(this.mapMove.bind(this),init.mapSetinterval)},handelMapFalse:function(){$(window).off("keydown",this.mapKeyDown),$(window).off("keyup",this.mapKeyUp)},handelMapTrue:function(){$(window).on("keydown",this.mapKeyDown),$(window).on("keyup",this.mapKeyUp)},handleObjectId:function(t){var e;e=3!=this.state.mapObjects?this.state.jsonParse.styles.length:this.state.jsonParse.isMove.length,!isNaN(Math.floor(t.target.value))&&t.target.value<e&&t.target.value>=0&&this.setState({objectNum:Math.floor(t.target.value)})},handleObjectsName:function(t){var e=this.state.jsonParse;3==this.state.mapObjects?e.styles[this.state.objectNum].n=t.target.value:e.isMove[this.state.objectNum].n=t.target.value,this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e})},handleObjectsX:function(t){if(!isNaN(t.target.value)){var e=this.state.jsonParse;e.styles[this.state.objectNum].x=t.target.value,this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e})}},handleObjectsY:function(t){if(!isNaN(t.target.value)){var e=this.state.jsonParse;e.styles[this.state.objectNum].y=t.target.value,this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e})}},handleObjectsW:function(t){if(!isNaN(t.target.value)){var e=this.state.jsonParse;e.styles[this.state.objectNum].w=t.target.value,this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e})}},handleObjectsH:function(t){if(!isNaN(t.target.value)){var e=this.state.jsonParse;e.styles[this.state.objectNum].h=t.target.value,this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e})}},handleObjectsSX:function(t){if(!isNaN(t.target.value)){var e=this.state.jsonParse;e.styles[this.state.objectNum].h=t.target.value,this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e})}},handleObjectsSY:function(t){if(!isNaN(t.target.value)){var e=this.state.jsonParse;e.styles[this.state.objectNum].h=t.target.value,this.setState({json:JSON.stringify(e,null,"	"),jsonParse:e})}},render:function(){var t,e=this.state;switch(e.mapObjects){case 1:t="前層";break;case 2:t="後層";break;case 3:t="碰撞區域"}return React.createElement("div",{id:"container"},React.createElement("div",{id:"map",style:{WebkitTransform:"translate3D("+e.mapLeft*this.props.map.sX+"px,"+e.mapTop*this.props.map.sY+"px,0)",msTransform:"translate3D("+e.mapLeft*this.props.map.sX+"px,"+e.mapTop*this.props.map.sY+"px,0)",transform:"translate3D("+e.mapLeft*this.props.map.sX+"px,"+e.mapTop*this.props.map.sY+"px,0)",width:e.width,height:e.height},onMouseDown:this.drawDown,onMouseMove:this.drawMove,onMouseUp:this.drawUp,onContextMenu:this.contextMenu},React.createElement("canvas",{width:e.width,height:e.height,style:{opacity:e.opacityB},id:"objectBack"}),React.createElement("canvas",{width:e.width,height:e.height,style:{opacity:e.opacityF},id:"objectFront"}),React.createElement("canvas",{width:e.width,height:e.height,style:{opacity:e.opacityM},id:"objectIsMove"}),React.createElement("canvas",{width:e.width,height:e.height,id:"grid"})),React.createElement(Sprites,{style:{WebkitTransform:"translateY("+e.sprite.top*this.props.map.sY+"px)",msTransform:"translateY("+e.sprite.top*this.props.map.sY+"px)",transform:"translateY("+e.sprite.top*this.props.map.sY+"px)"},onWheel:this.handleWheel,onMouseDown:this.handleMouseDown,onContextMenu:this.contextMenu},React.createElement("canvas",{width:"256",height:"12000",id:"spriteCanvas"}),React.createElement("img",{src:e.spritesSrc})),React.createElement(Top,null,React.createElement("textarea",{id:"jsoncode",value:e.json}),React.createElement("textarea",{id:"jsontext",onChange:this.handleChange,placeholder:"Object Json"}),React.createElement("input",{id:"spritesSrc",value:e.spritesSrc,onChange:this.handleSprite}),React.createElement("input",{id:"objectname",onChange:this.handleObjectName,placeholder:"Object Name"}),React.createElement("input",{id:"mapWidth",onChange:this.mapWidth,value:e.width}),React.createElement("input",{id:"mapHeight",onChange:this.mapHeight,value:e.height})),3!=e.mapObjects&&null!=e.mapObjects?React.createElement(Ui,null,React.createElement("label",{htmlFor:"area"},"區域物件"),React.createElement("input",{id:"area",value:t}),React.createElement("label",{htmlFor:"id"},"物件ID"),React.createElement("input",{id:"id",type:"number",onChange:this.handleObjectId,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.objectNum}),React.createElement("label",{htmlFor:"name"},"物件名"),React.createElement("input",{id:"name",onChange:this.handleObjectsName,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.styles[e.objectNum].n}),React.createElement("label",{htmlFor:"x"},"X 座標"),React.createElement("input",{id:"x",onChange:this.handleObjectsX,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.styles[e.objectNum].l}),React.createElement("label",{htmlFor:"y"},"Y 座標"),React.createElement("input",{id:"y",onChange:this.handleObjectsY,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.styles[e.objectNum].t}),React.createElement("label",{htmlFor:"width"},"物件寬"),React.createElement("input",{id:"width",onChange:this.handleObjectsW,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.styles[e.objectNum].w}),React.createElement("label",{htmlFor:"height"},"物件高"),React.createElement("input",{id:"height",onChange:this.handleObjectsH,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.styles[e.objectNum].h}),React.createElement("label",{htmlFor:"background"},"物件主圖"),React.createElement("input",{id:"background",value:e.jsonParse.styles[e.objectNum].b}),React.createElement("label",{htmlFor:"spriteX"},"物件拼圖 X 座標"),React.createElement("input",{id:"spriteX",onChange:this.handleObjectsSX,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.styles[e.objectNum].x}),React.createElement("label",{htmlFor:"spriteY"},"物件拼圖 Y 座標"),React.createElement("input",{id:"spriteY",onChange:this.handleObjectsSY,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.styles[e.objectNum].y}),React.createElement("label",{htmlFor:"zindex"},"物件前後層"),React.createElement("input",{id:"zindex",value:e.jsonParse.styles[e.objectNum].z})):null,3==e.mapObjects?React.createElement(Ui,null,React.createElement("label",{htmlFor:"area"},"區域物件"),React.createElement("input",{id:"area",value:t}),React.createElement("label",{htmlFor:"id"},"物件ID"),React.createElement("input",{id:"id",onChange:this.handleObjectId,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,type:"number",value:e.objectNum}),React.createElement("label",{htmlFor:"name"},"物件名"),React.createElement("input",{id:"name",onChange:this.handleObjectsName,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.isMove[e.objectNum].n}),React.createElement("label",{htmlFor:"x"},"X 座標"),React.createElement("input",{id:"x",onChange:this.handleObjectsX,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.isMove[e.objectNum].x}),React.createElement("label",{htmlFor:"y"},"Y 座標"),React.createElement("input",{id:"y",onChange:this.handleObjectsY,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.isMove[e.objectNum].y}),React.createElement("label",{htmlFor:"width"},"物件寬"),React.createElement("input",{id:"width",onChange:this.handleObjectsW,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.isMove[e.objectNum].w}),React.createElement("label",{htmlFor:"height"},"物件高"),React.createElement("input",{id:"height",onChange:this.handleObjectsH,onKeyDown:this.handelMapFalse,onKeyUp:this.handelMapTrue,value:e.jsonParse.isMove[e.objectNum].h}),React.createElement("label",{htmlFor:"events"},"事件ID"),React.createElement("input",{id:"events",value:e.jsonParse.isMove[e.objectNum].e}),React.createElement("label",{htmlFor:"inMap"},"入場圖"),React.createElement("input",{id:"inMap",value:e.jsonParse.isMove[e.objectNum].cm}),React.createElement("label",{htmlFor:"inMapPoint"},"入場點"),React.createElement("input",{id:"inMapPoint",value:e.jsonParse.isMove[e.objectNum].cmm})):null)}}),Ui=React.createClass({displayName:"Ui",render:function(){return React.createElement("div",{className:"ui"},this.props.children)}}),map=React.render(React.createElement(Root,null),document.body);